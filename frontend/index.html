<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TON Tip Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Rubik,system-ui,'Segoe UI',Arial}
    .glass{backdrop-filter:blur(12px)}
  </style>

  <!-- (אופציונלי) SEO/OG -->
  <meta name="description" content="תרומות TON מהירות, קהילה עסקית בטלגרם והטבות לחברים.">
  <meta property="og:title" content="TON Tip Store">
  <meta property="og:description" content="תרומת TON מהירה וידידותית. הצטרפו לקהילה וקבלו הטבות.">
  <meta property="og:image" content="https://tonfront.onrender.com/frontendassets/536279550_10237941019841362_2777380265588054892_n.jpg">
  <meta property="og:url" content="https://tonfront.onrender.com/">
  <meta name="twitter:card" content="summary_large_image">

  <!-- TON Connect UI: כפתור התחברות + שליחת טרנזקציה כשמחוברים -->
  <script type="module">
    import { TonConnectUI } from 'https://esm.run/@tonconnect/ui@2.2.0';
    window.__tonConnectUI = new TonConnectUI({
      manifestUrl: 'https://tonfront.onrender.com/tonconnect-manifest.json',
      buttonRootId: 'ton-connect',
      uiPreferences: { theme: 'SYSTEM' },
      actionsConfiguration: {
        returnStrategy: 'https://tonfront.onrender.com',
        twaReturnUrl: 'https://t.me/hbdcommunity_bot'
      }
    });
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100">
  <!-- HEADER -->
  <header class="p-4 sm:p-6">
    <div class="max-w-4xl mx-auto flex items-center justify-between gap-3">
      <div class="text-xl sm:text-2xl font-extrabold tracking-tight">TON Tip Store</div>
      <a id="communityLinkTop"
         class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition shadow w-auto">
        הצטרפות לקהילה
      </a>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-4xl mx-auto px-4 sm:px-6">
    <div class="grid gap-6 sm:grid-cols-2 items-start">
      <!-- מידע / פרימיום -->
      <section class="p-5 sm:p-6 rounded-3xl bg-white/60 glass shadow-lg">
        <img
          src="/frontendassets/536279550_10237941019841362_2777380265588054892_n.jpg"
          onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1557821552-17105176677c?q=80&w=1470&auto=format&fit=crop';"
          class="rounded-2xl w-full h-48 sm:h-56 md:h-64 object-cover mb-4" alt="hero" />
        <h1 class="text-2xl sm:text-3xl font-extrabold mb-2">ארנק טלגרם למסחר חופשי</h1>
        <p class="text-gray-700 leading-relaxed">
          האם ידעתם? כל עוד אתם משתמשים בארנק טלגרם הכספים שלכם המצויים בו מוגדרים כהשקעה לכל דבר, על כן *לא* מחוייבים במס בפועל!!
        </p>

        <!-- בלוק טקסט -->
        <section class="mt-5 p-4 rounded-2xl bg-gray-50 text-gray-800">
          <h3 class="font-bold mb-2">התוכן שלכם/הכסף שלכם/החופש שלכם</h3>
          <p>
            רק דמיינו זירת מסחר חופשית בלי ניתנת למעקב או עיקולים ולמעשה עצמאית לחלוטין, התוכן שלכם יכול להיות כאן!
          </p>
        </section>

        <div class="mt-4 rounded-xl bg-blue-50 p-4 text-blue-900">
          💡 כל תרומה לקידום שיפור יוקר המחיה והתנאים בארצנו תזכה במוצרים יחודיים לחברינו 🎁
        </div>
      </section>

      <!-- בלוק תמיכה/תשלום -->
      <section class="p-5 sm:p-6 rounded-3xl bg-white shadow-xl md:sticky md:top-6">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-2xl font-bold">תמכו ביוצר</h2>
          <!-- כפתור התחברות/התנתקות של TON Connect -->
          <div id="ton-connect"></div>
        </div>

        <div class="mt-4">
          <label class="block text-sm text-gray-600 mb-1">סכום התרומה (TON)</label>
          <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
            <input id="amount" type="number" step="0.01" min="0"
                   class="w-full sm:w-40 px-3 py-2 rounded-xl border border-gray-200 focus:outline-none focus:ring focus:border-blue-400"
                   value="1" />
            <button id="payNow"
                    class="w-full sm:w-auto px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 transition shadow">
              שלם עכשיו
            </button>
          </div>
        </div>

        <!-- בונוס לאחר תרומה (MVP) -->
        <div class="mt-6 rounded-xl bg-green-50 p-4 text-green-900 hidden" id="unlockedBox">
          ✅ תודה על תרומתכם! התוכן נחשף: <a href="#" class="underline">הורדת קובץ/קישור בונוס</a>
        </div>

        <!-- שני הכפתורים למטה -->
        <div class="mt-4 flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
          <button id="payWithTelegram"
                  class="w-full sm:w-auto px-4 py-2 rounded-xl border hover:bg-gray-50 transition">
            לבוט טלגרם שלנו
          </button>
          <button id="openWallet"
                  class="w-full sm:w-auto px-4 py-2 rounded-xl border bg-white hover:bg-gray-50 transition">
            מעבר לארנק טון
          </button>
        </div>

        <div class="mt-4 text-right">
          <button id="unlockBtn"
                  class="w-full sm:w-auto px-4 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition">
            כבר תרמתי — פתח בונוס
          </button>
          <div class="mt-2 text-xs text-gray-500" id="tc-status">לא מחובר</div>
          <div id="tg-hint" class="mt-2 text-xs text-amber-700 hidden">נראה שאתה בתוך דפדפן טלגרם. אם החיבור לא נפתח, נסה "פתח בדפדפן" או לחץ "מעבר לארנק טון".</div>
        </div>
      </section>
    </div>

    <!-- בלוק קהילה -->
    <section class="mt-8 p-5 sm:p-6 rounded-3xl bg-white/70 glass shadow-lg">
      <h2 class="text-2xl font-extrabוט mb-2">הצטרפו לקהילה בטלגרם</h2>
      <p class="text-gray-700">התייעצו, קבלו עדכונים, ושאלות על תשלומי TON לעסק שלכם גם. הצטרפו לקהילה העסקית החזקה בארץ.</p>
      <a id="communityLinkBottom"
         class="mt-4 inline-block px-5 py-3 rounded-2xl bg-blue-600 text-white hover:bg-blue-700 shadow">
        מעבר לקהילה
      </a>
    </section>

    <footer class="py-10 text-center text-gray-500">
     🚀 פרויקט זה נבנה על רשת טלגרם המיוצגת על ידי מטבע סלה ללא גבולות שהונפק על ידי "תנועת אחדות - החופש שלנו" 🚀
    </footer>
  </main>

  <!-- === קונפיג מה-API === -->
  <script>
    const API_BASE = 'https://ton-2eg2.onrender.com';

    async function loadConfig() {
      const res = await fetch(API_BASE + '/config', { cache: 'no-store' });
      return res.json();
    }
    function toNano(ton){ return Math.round(Number(ton) * 1e9); }
    function encodeQuery(q){ return Object.entries(q).map(([k,v]) => k + '=' + encodeURIComponent(String(v))).join('&'); }
    function saveUnlocked(){ localStorage.setItem('unlocked','1'); }
    function isUnlocked(){ return localStorage.getItem('unlocked')==='1'; }
    function showUnlocked(){ document.getElementById('unlockedBox').classList.remove('hidden'); }

    (async () => {
      const cfg = await loadConfig();
      window.__cfg = cfg;

      const amountEl = document.getElementById('amount');
      const unlockBtn= document.getElementById('unlockBtn');
      const commTop  = document.getElementById('communityLinkTop');
      const commBot  = document.getElementById('communityLinkBottom');
      const statusEl = document.getElementById('tc-status');

      amountEl.value = cfg.minDonationTon ?? 1;

      const botOrCommunity = (cfg.botLink || cfg.communityLink || '').trim();
      if (commTop) commTop.href = cfg.communityLink || botOrCommunity;
      if (commBot) commBot.href = cfg.communityLink || botOrCommunity;

      const tc = window.__tonConnectUI;
      tc.onStatusChange((w) => {
        if (w?.account?.address) {
          const a = w.account.address;
          statusEl.textContent = `מחובר: ${a.slice(0,6)}…${a.slice(-4)}`;
        } else {
          statusEl.textContent = 'לא מחובר';
        }
      });

      unlockBtn.onclick = () => { if (isUnlocked()) showUnlocked(); else alert('הבונוס נפתח אחרי תרומה (MVP).'); };
      if (isUnlocked()) showUnlocked();

      // רמז אם נכנסים מתוך טלגרם
      const ua = navigator.userAgent || '';
      if (/Telegram/i.test(ua)) document.getElementById('tg-hint').classList.remove('hidden');
    })().catch(e => { console.error(e); alert('שגיאה בטעינת קונפיג.'); });
  </script>

  <!-- === לוגיקה: שלם עכשיו (TonConnect אמיתי → openModal → פולבק), טלגרם, פתיחת ארנק === -->
  <script type="module">
    const payNowBtn     = document.getElementById('payNow');
    const tgBtn         = document.getElementById('payWithTelegram');
    const openWalletBtn = document.getElementById('openWallet');

    payNowBtn.addEventListener('click', async () => {
      const cfg = window.__cfg || {};
      const seller = cfg.sellerTonAddress || '';
      if (!seller) { alert('SELLER_TON_ADDRESS חסר ב-API'); return; }

      const amt = parseFloat(document.getElementById('amount').value) || (cfg.minDonationTon || 1);
      const nano = String(Math.round(amt * 1e9));
      const tc = window.__tonConnectUI;

      // פונקציית פולבק: deeplink → ואם לא זזים מהעמוד → Telegram Wallet
      const fallbackDeepLink = () => {
        const deeplink = `ton://transfer/${seller}?` + new URLSearchParams({ amount: nano, text: 'Thanks for your work!' }).toString(); /* amount=nanoton :contentReference[oaicite:1]{index=1} */

        let returned = false;
        const onBack = () => {
          if (returned) return;
          returned = true;
          fetch(API_BASE + '/log-donation', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ amountTon: amt, to: seller, comment: 'deeplink', source: 'payNow' })
          }).catch(()=>{});
          saveUnlocked(); showUnlocked();
          document.removeEventListener('visibilitychange', visHandler);
        };
        const visHandler = () => { if (document.visibilityState === 'visible') onBack(); };
        document.addEventListener('visibilitychange', visHandler);

        window.location.href = deeplink;
        setTimeout(() => {
          if (document.visibilityState === 'visible') {
            window.open('https://t.me/wallet', '_blank', 'noopener');
          }
        }, 1200);
      };

      try {
        if (!tc?.connected) {
          // פותח בחירת ארנקים; אם המשתמש מחבר ארנק – נשלח דרך TonConnect
          await tc.openModal?.();
        }
        if (tc?.connected) {
          // שליחת טרנזקציה אמיתית דרך TonConnect (address+amount בנאנו) :contentReference[oaicite:2]{index=2}
          const tx = {
            validUntil: Math.floor(Date.now() / 1000) + 600,
            messages: [{ address: seller, amount: nano }]
          };
          const result = await tc.sendTransaction(tx);

          // לוג + פתיחת ההטבה
          fetch(API_BASE + '/log-donation', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ amountTon: amt, to: seller, source: 'tonconnect', result: result ? { ok: true } : {} })
          }).catch(()=>{});
          saveUnlocked(); showUnlocked();
          return;
        }
      } catch (e) {
        console.error('TonConnect send/open failed, fallback to deeplink', e);
      }

      // אם אין חיבור/נכשל – פולבק
      fallbackDeepLink();
    });

    // לבוט טלגרם שלנו — start=donate_<amount> רק אם זה בוט (…/_bot)
    tgBtn.addEventListener('click', () => {
      const cfg = window.__cfg || {};
      const amt = parseFloat(document.getElementById('amount').value) || (cfg.minDonationTon || 1);
      let base = (cfg.botLink || cfg.communityLink || '').trim();

      if (!base) { alert('לא הוגדר קישור טלגרם (bot/community) ב-API'); return; }

      const m = base.match(/^https:\/\/t\.me\/([A-Za-z0-9_]+)$/);
      if (m && m[1].endsWith('_bot')) {
        base = `${base}${base.includes('?') ? '&' : '?'}start=donate_${encodeURIComponent(amt)}`;
      }
      window.location.href = base;
    });

    // מעבר לארנק טון — Tonkeeper (כמו קודם)
    openWalletBtn.addEventListener('click', () => {
      window.open('https://tonkeeper.com', '_blank', 'noopener');
    });
  </script>
</body>
</html>
