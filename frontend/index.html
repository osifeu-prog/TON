<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TON Tip Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Rubik,system-ui,'Segoe UI',Arial}
    .glass{backdrop-filter:blur(12px)}
  </style>

  <!-- TON Connect UI (ESM) -->
  <script type="module">
    import { TonConnectUI, THEME } from 'https://esm.run/@tonconnect/ui@2.2.0';
    window.__TCUI = { TonConnectUI, THEME };
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-blue-100">
  <!-- HEADER -->
  <header class="p-4 sm:p-6">
    <div class="max-w-5xl mx-auto flex items-center justify-between gap-3">
      <div class="text-xl sm:text-2xl font-extrabold tracking-tight">TON Tip Store</div>
      <a id="communityLinkTop"
         class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition shadow w-auto">
        הצטרפות לקהילה
      </a>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-5xl mx-auto px-4 sm:px-6">
    <!-- שתי עמודות כבר מ-640px; במובייל טור אחד נקי -->
    <div class="grid gap-6 sm:grid-cols-2 items-start">
      <!-- מידע / פרימיום -->
      <section class="p-5 sm:p-6 rounded-3xl bg-white/60 glass shadow-lg">
        <img src="/assets/hero.jpg"
             onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1557821552-17105176677c?q=80&w=1470&auto=format&fit=crop';"
             class="rounded-2xl w-full h-48 sm:h-56 md:h-64 object-cover mb-4" alt="hero" />
        <h1 class="text-2xl sm:text-3xl font-extrabold mb-2">מידע פרימיום / מוצר דיגיטלי</h1>
        <p class="text-gray-700 leading-relaxed">
          כאן תיאור קצר של התוכן — מה מקבלים, למי זה מתאים ולמה זה שווה. שמרו על 2–4 משפטים ממוקדים שמובילים לפעולה.
        </p>
        <div class="mt-4 rounded-xl bg-blue-50 p-4 text-blue-900">
          💡 MVP תרומה “רכה”: אחרי תרומה אפשר לפתוח בונוס/קובץ/קישור 🎁
        </div>
      </section>

      <!-- תרומה / ארנק / טלגרם -->
      <section class="p-5 sm:p-6 rounded-3xl bg-white shadow-xl md:sticky md:top-6">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-2xl font-bold">תמכו ביוצר</h2>
          <!-- כאן TON Connect יצייר את כפתור ההתחברות -->
          <div id="ton-connect"></div>
        </div>

        <div class="mt-4">
          <label class="block text-sm text-gray-600 mb-1">סכום התרומה (TON)</label>
          <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
            <input id="amount" type="number" step="0.01" min="0"
                   class="w-full sm:w-40 px-3 py-2 rounded-xl border border-gray-200 focus:outline-none focus:ring focus:border-blue-400"
                   value="0.5" />
            <!-- שלם דרך הארנק (TON Connect) -->
            <button id="payWithWallet"
                    class="w-full sm:w-auto px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 transition shadow">
              שלם דרך הארנק
            </button>
            <!-- שלם באמצעות טלגרם (לבוט/קהילה) -->
            <button id="payWithTelegram"
                    class="w-full sm:w-auto px-4 py-2 rounded-xl border hover:bg-gray-50 transition">
              שלם באמצעות טלגרם
            </button>
            <!-- כפתור התנתקות ארנק -->
            <button id="disconnectWallet"
                    class="w-full sm:w-auto px-4 py-2 rounded-xl border border-red-300 text-red-700 hover:bg-red-50 transition hidden">
              התנתק ארנק
            </button>
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-sm text-gray-600 mb-1">כתובת היוצר (TON)</label>
          <div class="flex flex-col sm:flex-row gap-2">
            <code id="address" class="px-3 py-2 bg-gray-100 rounded-xl text-sm overflow-x-auto">loading…</code>
            <button id="copyBtn" class="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 text-sm w-full sm:w-auto">העתק</button>
          </div>
        </div>

        <!-- בונוס לאחר תרומה (MVP) -->
        <div class="mt-6 rounded-xl bg-green-50 p-4 text-green-900 hidden" id="unlockedBox">
          ✅ תודה! התוכן הנוסף נחשף: <a href="#" class="underline">הורדת קובץ/קישור בונוס</a>
        </div>

        <div class="mt-4 text-right">
          <button id="unlockBtn"
                  class="w-full sm:w-auto px-4 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition">
            כבר תרמתי — פתח בונוס
          </button>
          <div class="mt-2 text-xs text-gray-500" id="tc-status">לא מחובר</div>
        </div>
      </section>
    </div>

    <!-- בלוק קהילה -->
    <section class="mt-8 p-5 sm:p-6 rounded-3xl bg-white/70 glass shadow-lg">
      <h2 class="text-2xl font-extrabold mb-2">הצטרפו לקהילה בטלגרם</h2>
      <p class="text-gray-700">התייעצו, קבלו עדכונים, ושאלות על תשלומי TON לעסק.</p>
      <a id="communityLinkBottom"
         class="mt-4 inline-block px-5 py-3 rounded-2xl bg-blue-600 text-white hover:bg-blue-700 shadow">
        מעבר לקהילה
      </a>
    </section>

    <footer class="py-10 text-center text-gray-500">
      נבנה במהירות עבור MVP על TON 🚀
    </footer>
  </main>

  <!-- === קונפיג מה-API + עזרי UI (ללא דיפ-לינקים) === -->
  <script>
    const API_BASE = 'https://ton-2eg2.onrender.com'; // שירות ה-API שלך ב-Render

    async function loadConfig() {
      const res = await fetch(API_BASE + '/config', { cache: 'no-store' });
      return res.json();
    }
    function saveUnlocked(){ localStorage.setItem('unlocked','1'); }
    function isUnlocked(){ return localStorage.getItem('unlocked')==='1'; }
    function showUnlocked(){ document.getElementById('unlockedBox').classList.remove('hidden'); }

    (async () => {
      const cfg = await loadConfig();
      window.__cfg = cfg; // זמין גם לסקריפט TON Connect

      const addrEl   = document.getElementById('address');
      const copyBtn  = document.getElementById('copyBtn');
      const amountEl = document.getElementById('amount');
      const unlockBtn= document.getElementById('unlockBtn');
      const commTop  = document.getElementById('communityLinkTop');
      const commBot  = document.getElementById('communityLinkBottom');

      addrEl.textContent = cfg.sellerTonAddress || '—';
      amountEl.value = cfg.minDonationTon ?? 0.5;

      // קישורי קהילה/בוט
      const botOrCommunity = cfg.botLink || cfg.communityLink || '#';
      if (commTop) commTop.href = cfg.communityLink || botOrCommunity;
      if (commBot) commBot.href = cfg.communityLink || botOrCommunity;

      // העתקה
      copyBtn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(cfg.sellerTonAddress || '');
          copyBtn.textContent = 'הועתק!';
          setTimeout(()=>copyBtn.textContent='העתק', 1200);
        } catch { alert('לא ניתן להעתיק אוטומטית בדפדפן זה'); }
      };

      // פתיחת הבונוס ידנית (MVP)
      unlockBtn.onclick = () => { if (isUnlocked()) showUnlocked(); else alert('הבונוס נפתח אחרי תרומה (MVP).'); };
      if (isUnlocked()) showUnlocked();
    })().catch(e => { console.error(e); alert('שגיאה בטעינת קונפיג.'); });
  </script>

  <!-- === TON Connect: חיבור/התנתקות + תשלום דרך ארנק === -->
  <script type="module">
    const { TonConnectUI } = window.__TCUI || {};
    const statusEl = document.getElementById('tc-status');
    const payBtn   = document.getElementById('payWithWallet');
    const tgBtn    = document.getElementById('payWithTelegram');
    const disconnectBtn = document.getElementById('disconnectWallet');
    const amountInput  = document.getElementById('amount');

    function toNanoStr(x){ return (Math.round(Number(x) * 1e9)).toString(); }

    // אתחול כפתור החיבור (יצייר ב-#ton-connect)
    const tc = new TonConnectUI({
      manifestUrl: 'https://tonfront.onrender.com/tonconnect-manifest.json',
      buttonRootId: 'ton-connect',
      uiPreferences: { theme: 'SYSTEM' }
    });

    // סטטוס + כפתור התנתקות
    tc.onStatusChange((w) => {
      if (w?.account?.address) {
        const a = w.account.address;
        statusEl.textContent = `מחובר: ${a.slice(0,6)}…${a.slice(-4)}`;
        disconnectBtn.classList.remove('hidden');
      } else {
        statusEl.textContent = 'לא מחובר';
        disconnectBtn.classList.add('hidden');
      }
    });

    // תשלום דרך הארנק (TonConnect)
    payBtn.addEventListener('click', async () => {
      try {
        const cfg = window.__cfg || await (await fetch('https://ton-2eg2.onrender.com/config', {cache:'no-store'})).json();
        const seller = cfg?.sellerTonAddress;
        if (!seller) { alert('SELLER_TON_ADDRESS חסר ב-API'); return; }

        if (!await tc.connected) {
          await tc.openModal();
          await new Promise((res) => {
            const off = tc.onStatusChange((w)=>{ if (w?.account) { off(); res(); }});
          });
        }

        const amt = amountInput.value && Number(amountInput.value) > 0 ? Number(amountInput.value) : (cfg?.minDonationTon || 0.5);

        await tc.sendTransaction({
          validUntil: Math.floor(Date.now()/1000) + 600,
          messages: [{ address: seller, amount: toNanoStr(amt) }]
        }, { skipRedirectToWallet: 'ios' });

        // הצלחה לוגית: נפתח בונוס (MVP)
        localStorage.setItem('unlocked','1');
        document.getElementById('unlockedBox').classList.remove('hidden');
      } catch (e) {
        console.error(e);
        alert('שגיאה בשליחה דרך הארנק.');
      }
    });

    // תשלום דרך טלגרם (פתיחת בוט/קהילה)
    tgBtn.addEventListener('click', () => {
      const cfg = window.__cfg || {};
      const amt = amountInput.value && Number(amountInput.value) > 0 ? Number(amountInput.value) : (cfg?.minDonationTon || 0.5);
      const base = (cfg.botLink || cfg.communityLink || '').trim();

      if (!base) { alert('לא הוגדר קישור טלגרם בקונפיג.'); return; }

      // אם זה בוט (t.me/<bot>) נוסיף start עם סכום כדי שהבוט יזהה
      const url = base.startsWith('https://t.me/')
        ? `${base}${base.includes('?') ? '&' : '?'}start=donate_${encodeURIComponent(amt)}`
        : base;

      window.location.href = url;
    });

    // התנתקות ארנק
    disconnectBtn.addEventListener('click', async () => {
      try { await tc.disconnect(); } catch(e){ console.error(e); }
    });
  </script>
</body>
</html>
